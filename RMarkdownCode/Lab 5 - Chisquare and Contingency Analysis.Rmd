---
title: "Lab 5 - Chisquare and Contingency Analysis"
output: 
  html_document:
    theme: readable
    highlight: haddock
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir =  "~/Dropbox/Biometrics Labs/Lab 5 - Chisquare and Contingency Analysis")
```

___

## Lab Objectives:
- Conduct Chi-Square goodness-of-fit tests
- Enter frequency data and assign weighting
- Calculate a Poisson distribution
- Conduct a Chi-square contingency test and Fisher’s Exact test for contingency tables
- Use R to determine odds ratio and relative risk


___

```{r, echo=FALSE}
setwd("~/Dropbox/Biometrics Labs/Lab 5 - Chisquare and Contingency Analysis")
```

 
# Exercise 1: Chi-Square testing in R

A Chi-Square test is used to analyze frequency data for categorical or discrete numerical variables. It compares observed frequencies to expected or predicted frequencies. We will conduct Chi-square goodness-of-fit tests to analyze frequency distributions of a single variable, and Chi-Square contingency tests to analyze associations between two or more categorical variables.

Note that a Statistical Table (χ2 Distribution) can be found at the end of this file.

___


## Days of the week

In class, we looked at a research study examining the number of births on each day of the week. We will examine this data set, but will consider a scenario where every day of the week has an equal probability (e.g. 1/7). This data is found in the file Days of the week.sav

Open Days of the week.csv (these data are straightforward enough they can be plotted with the plot(d) command:

```{r}
d<-read.csv("days of the week.csv")
plot(d, cex.names=0.8)
```

Tabulate the variable day, from within the d data.frame and perform a chi-square test:

```{r}
x<-xtabs(~d$day)
chisq.test(x)
```

By default, the chisq.test will assume that the null expectation is equally distributed across the categories, weighted by column sum or row sums.  In this example, there are only 7 categories, so the null expectation is the sum of all observations divided by 7:

```{r}
freq<-rep(sum(x)/7,7)
p<-freq/sum(x)
chisq.test(x, p=p)
```

which yields the same result.  You might specify a different null by providing a unique set of frequencies.  The __chisq.test()__ function requires that the frequencies be supplied as a vector of probabilities that sum to 1.

By default, the function provides only the essential statistical outputs.  It provides the χ2 value (X-squared), the degrees of freedom (df), and the significance value.

You could report this in a scientific paper as: χ2 (df=6) = 15; p=0.02

To obtain more detailed information, you should create an object that contains the results of the analysis:

```{r}
results<-chisq.test(x,p=p)
str(results)
results$expected
results$residuals
results$stdres
```

In the output above, you should see a table showing each day of the week, the expected N for each category, the residuals [(O-E)/sqrt(E)], and standardised residuals.

<br>

#### Answer questions 1 and 2 on sakai

<br>
```{r, echo=FALSE}
answer1<-"Observed - Expected" # what do the residuals mean in the chi square results
answer2a1<-chisq.test(x, p=p)$statistic
answer2a1<-chisq.test(x, p=p)$p.value
# the Chi Square value for number of babies born on each day of the week is 15.240. This is an exact P-value of 0.018.
answer2b<-"the P-value would be estimated to be less than 0.025 but greater than 0.010"
# Using a Chi Square statistical table, the P-value would be estimated to be less than 0.025 but greater than 0.010.

```

___

## Birds in a storm

There are two ways that R can work with frequency data. The first we have worked with extensively already: each row represents an individual or observation, and each column represents a variable. The value of a categorical variable in a given cell describes which group the individual in that row belongs to.

Alternatively, in some cases you may have frequency data that is already organized into a table, or summarized as such. For example, you may be interested in the sex of birds collected at a particular site following a wind storm. You have recorded that 49 females and 87 males were caught. In this case it would be quicker to input this data into R in summary format, rather than filling in 49 rows for females, and 87 rows for males.

The easiest way to do that for two categories to to create a vector using the __c()__ function.  With 2x2 tables or more complex data, you would need to use the __as.matrix()__ function to convert the date into a 2 dimensional variable.  Below we show both approaches:

```{r}
x<-c(49,87)
chisq.test(x)

x<-as.matrix(c(Females=49, Males=87), nrow=2)
chisq.test(x)
```

Recently we focused on conducting binomial tests. A binomial test compares the observed number of successes to that expected under the null hypothesis, and calculates an exact P-value. A binomial test can only be used when there are only two categories. The Chi-Square goodness-of-fit test also works when there are only two categories and can be a quick substitute for the binomial test when calculating statistics by hand.

When calculated with a statistics program, the Chi-Square test is still an approximation based on the Chi-Square probability distribution with a particular number of degrees of freedom. It will provide a P-value, but this will not be as precise as the P-value calculated with the binomial test. Let’s check the difference using the bird data:

```{r}
binom.test(x, p=0.5, alternative="two.sided")
binom.test(x, p=0.5, alternative="two.sided")$p.value 
# compare to the p value from the chisq.test run earlier
chisq.test(x)$p.value
```

<br>

#### Answer question 3 on Sakai

```{r, echo=FALSE}
#A) Using the binomial test, the exact P-value for the proportion of female birds caught following a wind storm was 0.0014.
#B) Using the Chi Square test, the estimated P-value was 0.0011.
```

___

## Not at all like me

Now let’s try an example where the expected values are not equal across categories. The difference here is we have to specify the expected proportions or counts. Howell has a hypothesis that if you ask participants to sort one-sentence characteristics of themselves (such as “I eat too fast”) into five piles ranging from “not at all like me”, to “very much like me”, the percentage of items placed in each pile will be approximately 10%, 20%, 40%, 20%, and 10% for the five piles. Let’s test this hypothesis using data gathered from 50 sorted statements.

```{r}
d<-read.csv("not like me.csv")
str(d)
levels(d$Category)
x<-d$Frequency
p<-d$PredPercent
# there are 5 levels in Category corresponding to the subject's answer. 
# we need to rescale the p values to sum up to 1, not 100 when using the chisq.test function

```

Perform a chisq.test on the data above.

<br>

#### Answer question 4 and 5 on Sakai

```{r, echo=FALSE}
result<-chisq.test(x, p=p, rescale.p=T)
answer4a<-result$statistic # The “not like me” data has a Chi-square value of 2.05. 
answer4b<-result$parameter # There are 4 degrees of freedom.
answer4c<-result$p.value   # The P-value is 0.727.
answer5<-"Howell’s hypothesis that individuals sort descriptive statements into piles of approximately 10%, 20%, 40%, 20%, and 10% is supported by the data."
```

<br>

___

# Exercise 2: Poisson Distribution

The Poisson distribution describes the frequency distribution of successes, when successes happen independently and with equal probability over time or space. Given a mean number of events observed in a given time or space, the Poisson distribution can be used to determine the probability of observing X number of events in that same unit of time or space. If successes occur “randomly” in time or space, then the distribution of values should follow the Poisson distribution.

___

## Emergency

Let’s check the Poisson distribution for the number of people admitted to the ER between 7 and 8 pm on Friday night, given an average admittance of 2.4 people. We will assume that admissions are independent of one another, and are just as likely to land in one instant in time as another on a Friday night. Your boss at the hospital is adjusting staff schedules and is interested in the probability that 0 – 10 patients will be admitted during this time period.

ppois() returns a cumulative probability that the stated X will be <= to a threshold value.  So if you want the probability of a specific whole number value, you will have to calculated two probabilities and subtract one from the other.  

For example, if you wanted to know the probabilty of 5 people being admitted, calculate the cumulative probabilty of 5 or less, and subtract the cumulative probability of 4 or less:

```{r}
ppois(q=5, lambda=2.4) - ppois(q=4, lambda=2.4)
```

To do this for every discrete value can be tedious to code, but there is another function, __dpois()__ that helps.  If you supply it with a vector of numbers, it will evaluate the probabilty density at each of those values:

```{r}
probs<-dpois(0:10, lambda=2.4)
plot(x=0:10, y=probs, type="l", xlab="x = 0:10", ylab="probability" )

```

Note that these values indicate the probability of 0, 1, 2, 3, ... 10 people admitted during this time period, given a mean number of admittances of 2.4, and each admittance being independent and occurring with equal probability.

<br>

#### Answer question 6 on Sakai

```{r, echo=FALSE}
answer6a<-probs[1] # 0.09072
abswer6b<-probs[5] # 0.1254
# According to a Poisson distribution with a mean of 2.4, the probability of 0 patients admitted between 7 and 8pm on Friday night is 0.091. The probability of 4 patients admitted is 0.125.
```

<br>

___


## Truffles

Truffles are a great delicacy. A set of plots of equal size in an old-growth forest in Northern California was surveyed to count the number of truffles per plot. The resulting distribution is found in the file Truffles.csv. The data include a total of 288 plots, and have a mean value of 0.604 truffles per plot. You are interested in determining whether truffles are randomly located around the forest. If not, they may be either clumped or dispersed.


```{r}
d<-read.csv("truffles.csv")
str(d)
d$Frequency
```

You might be tempted to perform a chi-squared test on these 5 categories, but remember what the default parameters are when testing chi-squared:

```{r}
result<-chisq.test(d$Frequency)
print(result)
result$expected
```

Calculate the probabilities of 0 – 4 truffles per plot using the __dpois()__  distribution function.

```{r}
# Here is the probability for 0 and 1 truffles per plot.  
dpois(0, lambda=0.604)
dpois(1, lambda=0.604)

```

Calculate the expected frequencies for each number of truffles per plot (0 – 4) according to the expected probabilities of the Poisson distribution and the total number of truffles collected. Try using R to perform this calculation directly.

Hint: Once you have a vector of probabilities, you can multiply it out by the sum of the total observations.  Create a new variable called freq to contain this output. 

Note that we cannot run a Chi-square test on this data, because one of our expected values is too low.  In a Chi-square test, no expected value can be less than 1. To get around this, you will have to combine the data for 3 and 4 truffles per plot into a single value.  Think about your categories as 0, 1, 2, and (3 to 4).

Run a Chi-square test on the data. Enter each of the expected frequencies you computed.

<br>

#### Answer question 7 on Sakai

```{r, echo=FALSE}
probs<-dpois(0:4, lambda=0.604)
freqs<-probs*sum(d$Frequency)
# one of these is too low (i.e. <5)
newfreqs<-freqs[1:4]
newfreqs[4]<-newfreqs[4]+freqs[5]
newx<-c(203, 39, 18, 13+15)
result<-chisq.test(newx, p=newfreqs, rescale.p=T)

# Question 7: Truffles are randomly located around the forest.
answer7<-FALSE # because the chi square test suggests they are not distributed as expected from a random distribution

```

<br>

___

# Exercise 3: Chi-Square for Contingency Analysis

The Chi-Square test can also be used to analyze whether two categorical variables are associated. That is, whether the two variables are independent, or whether the outcome of one variable depends on the other.

___ 

## The gnarly worm gets the bird

Example 9.4 in your book examines the life cycle of a parasite that is transferred from snails, to fish, to birds. The researchers noticed that infected fish spend more time near the water surface, and wanted to examine whether this influenced their chances of being ingested by a bird. An outdoor tank was stocked with uninfected, lightly infected, and heavily infected fish. The number of each that were eaten by birds was recorded. This data could be presented in a contingency table as follows:

```{r, echo=FALSE}
library(knitr)
df<-data.frame('Uninfected'=c(1,49,50), 'LightlyInfected'=c(10,35,45), 'HighlyInfected'=c(37,9,46), Total=c(48,93,191), row.names = c("Eaten", "Not Eaten", "Total"))
kable(df, col.names = c("Uninfected", "Lightly Infected", "Highly Infected", "Total"))

```

Remember that the response variable (eaten/not eaten in this case) is displayed in rows, while the explanatory variable is displayed in columns. This data is contained in the files worms.csv. We can use a Chi-Square test to determine whether parasite infection and being eaten are independent (H0) or not independent (HA).

Note that in this case we want to use Chi-Square to compare associations between two categorical variables. 

To be consistent with the contingency table, add the fate variable to the rows and the infection variable to the columns.  You can use the built-in __xtabs()__ to visualise the table:

```{r}
d<-read.csv("worms.csv")
str(d)
xtabs(~d$fate+d$infection)
```

To do a crosstabulation in R, you will need to install the packge "gmodels", using the install.packages("gmodels") command.

```{r}
# run this line without the comment if you don't have gmodels installed
# install.packages("gmodels")

# 2-Way Cross Tabulation
library(gmodels)
CrossTable(d$fate, d$infection, expected=TRUE, prop.c=FALSE, prop.r=FALSE, fisher=TRUE, format="SAS")
```

Review the crosstabulation table. This is similar to a contingency table, but shows both the observed and expected counts.  If fisher=TRUE, the results display the p value for a Fisher Exact test, which is required when any expected frequency is low (typically < 5).

In the Chi-Square test table we are interested in the Pearson Chi-Square results (what are labelled as the Chi-squared contributions, which are summed to obtain the actual Chi-square value).

<br>

#### Answer question 8 on sakai

<br>

```{r, echo=FALSE}
# Question 8A) If parasite infection and getting eaten by birds were independent, we would expect 15.7 highly infected fish to be eaten by birds.
# Question 8B) The Chi-Square value for infection and fate is 69.8.
answer8a<-15.66 
answer8b<-69.75571
```

___

## Small fry

A study by Miller et al examined the survival of rainbow trout fry (babies) in Lake Superior, comparing those that came from a government hatchery on the lake, and those that came from wild trout. The data is contained in fry.csv.

Open this file and conduct a Chi-Square test through the crosstab function, as above. Add frysource to the columns and survival to the rows. Display the observed and expected counts.

Note that in your output, since this is a 2 x 2 comparison, the results for Fisher’s Exact Test can also be displayed if the expected values are too low. The P-value for Fisher’s exact test is an exact P-value, rather than a close approximation as obtained with Chi-Square. Fisher’s Exact test must be used whenever the expected frequencies are too low for the Chi-Square test, but it is difficult to compute by hand.

<br>

#### Answer question 9 on sakai

```{r, echo=FALSE}
d<-read.csv("fry.csv")
# results<-CrossTable(d$survival, d$frySource, expected=TRUE, prop.c=FALSE, prop.r=FALSE, fisher=TRUE, format="SAS")

# The P-value for association between the origin of the fries (hatchery or wild) and fry survival is 0.006 according to the Pearson Chi-Square test, and 0.008 according to Fisher’s Exact test.
answer9a<-0.006318
answer9b<-0.008449

```

<br>

___

# Exercise 4: Odds Ratio & Relative Risk

An odds ratio measures the magnitude of association between two categorical variables when each variable has only two categories. It is calculated from the odds of a focal outcome in one group, divided by the odds of the same outcome in a second group. Odds are calculated by the probability of the focal outcome (success) divided by the probability of the alternate outcome (failure). A similar measure used in medical studies is relative risk, which is equal to the probability of an undesired outcome in the treatment group, divided by the probability of the same undesired outcome in the control group.

___

## Postnatal depression

Postnatal depression affects approximately 8 – 15% of new mothers. Patel et al (2005) examined whether the rates of postnatal depression differed between mothers who delivered vaginally (control), compared to mothers who delivered by C-section (treatment). The data is found in delivery.csv.

Open the file delivery.csv.

Perform a cross tabulation analysis.

```{r}
d<-read.csv("delivery.csv")
str(d)
counts<-table(d$Delivery,d$Depression)
counts

addmargins(counts)
CrossTable(counts, expected=TRUE, prop.c=FALSE, prop.r=FALSE, format="SAS")

# Mosaic plot of the association.
mosaicplot( counts, col = c("firebrick", "goldenrod1"), cex.axis = 1, 
	 ylab = "Relative frequency", main = "")
```

You can display the proportion of those experiencing the outcome, but within a row category using the __prop.table()__ function:

```{r}
prop.table(counts, margin=1)
addmargins(prop.table(counts, margin=1))
prop.table(counts, margin=1)*100  # multiply the proportions * 100 for percent
```

Setting margin=1 means that the proportion will be calculated within each row, separately from each other row.  Thus, each row should add up to 1, as demonstrated with the __addmargins()__ function.  For percentages, you can multiple the entire prop.table by 100.

Note that for determining odds and relative risk in R, the risk factor (delivery method) must be a row item, and the outcome we are interested in (depression) must be a column item (columns are often the 'disease' or outcome states).  This was achieved in the __CrossTable()__ function by the order of the variables.

For future reference, you could build the numbers into your own variable if you don't have them saved in a file, but it requires knowing how the __matrix()__ function operates:

```{r}
counts<-matrix(c(48,1025, 341,9520), nrow=2, 
               dimnames=list(c("C-Section", "vaginal"), 
                             c("Depression", "No Depression")))
counts
```

<br>

Next, calculate the odds ratio using the __epitools__ package. Install the package if you haven't already done so, using __'install.packages("epitools", dependencies=TRUE)'__
 
```{r}
# install.packages("epitools", dependencies = TRUE)
library(epitools)
```

This __oddratio()__ function expects the following table struture for your contingency table, with the reference condition usually in the first row, and disease states labeled according to reference of interest, where 0 is usually the state being compared to:

```{r, echo=FALSE}
df<-data.frame(disease0=c("n00","n10","n20","n30"), disease1=c("n01","n11","n21","n31"), row.names=c("exposed=0 (ref)", "exposed=1", "exposed=2", "exposed=4"))
kable(df, col.names=c("disease=0", "disease=1"))
```

The reason for this is because each level of exposure is compared to the reference level (row 1).

This layout looks a little different from what our __counts__ data look like, but the __oddsratio()__ function allows you to reverse the order of the rows and columns by setting rev="both":

```{r}
# default layout:
counts
# the layout the oddratio function wants, where row 1 and 2 are swapped and column 1 and 2 are swapped:
counts[2:1,2:1] 
# you can specify the reversal method when you call the oddratio function:
oddsratio(counts, rev="both", method = "wald")
```

In the $measure section, it shows the odds of developing depression with a C-section delivery compared to a vaginal delivery. If this number is greater than 1, then the odds of developing depression are higher with a C-section delivery. If this value is less than 1, then the odds of developing depression are lower with a C-section delivery.  The first row odds ratio is usually the reference state, so it will not have confidence limits and will be equal to 1.

The resulting output of oddsratio includes a lot of incidental computations. To get clean output only for the odds ratio, including the 95% confidence interval, use the following instead:

```{r}
oddsratio(counts, rev="both", method = "wald")$measure[-1,]
```

Do the confidence intervals exclude or include 1? 

Now, calculate relative risk using the __epitools__ package. To use the command with our counts contingency table, we need to reverse the order of the rows and columns, by setting the rev option = "both".  We can do this all at once with the following arguments to the riskratio function.


```{r}
library(epitools)
riskratio(counts, rev = "both", method = "wald")
```

The $measure section shows the relative risk for the outcome depression, with a C-section compared to vaginal birth.

Return to crosstabs, and conduct a Chi-Square test on the data to see if there is a significant difference in these outcomes. This test will tell you if the two variables (delivery method and depression) are independent.

<br>

#### Answer questions 10 and 11 on Sakai.

```{r, echo=FALSE}
# 10a. The odds ratio for developing depression with a C-section vs vaginal birth is 1.31.
# 10b. The relative risk for developing depression with a C-section vs. vaginal birth is 1.27.
# 11. According to a Fisher’s exact test, there is a statistically significant association between depression and delivery method. False
answer10a<-oddsratio(counts, rev="both", method = "wald")$measure[-1,][1]
answer10b<-riskratio(counts, rev="both", method = "wald")$measure[-1,][1]
# result<-CrossTable(counts, fisher=TRUE)
answer11<-FALSE # (p value from CrossTable function > 0.05)
```
<br>

___

# Exercise 5: Additional practice:


### Heart failure

The file heart failure.csv contains data on the day of the week that patients were admitted to a hospital with heart failure. Analyze this data using a Chi-Square test to determine if patients are admitted in equal proportions on each day of the week.

```{r, echo=FALSE}
d<-read.csv("heart failure.csv")
# table(d$NumberAdmitted)
result<-chisq.test(d$NumberAdmitted)$p.value<0.05
answer12<-factor(result==TRUE, levels=c(FALSE,TRUE), labels=c("accept", "reject"))
# According to the heart failure data, we reject the null hypothesis that patients with heart failure are admitted equally for every day of the week
```
___

### Feline high rise syndrome

A more recent study of feline high-rise syndrome (FHRS) included data on the month in which each of 119 cats fell. The data are found in the file Rainingcats.csv. Do a hypothesis test to determine whether the probability of FHRS is the same every month.


```{r, echo=FALSE}
d<-read.csv("raining cats.csv")
# table(d$month)
result<-chisq.test(table(d$month))$p.value<0.05
answer13<-result
# According to a Chi-Square test, we REJECT the null hypothesis that the incidence of cats with feline high-rise syndrome is equally distributed across all twelve months of the year.  Answer=TRUE
```
___

### MS and CCSVI

In 2012, a research group examined the association between MS and a vein condition known as chronic cerebrospinal venous insufficiency (CCSV). This data is found in the file CCSVI.csv. Conduct a Chi-Square test to determine whether there is a significant association between MS and CCSVI.

```{r, echo=FALSE}
d<-read.csv("CCSVI.csv")
counts<-table(d$MS, d$CCSVI)
result<-chisq.test(counts)
# CrossTable(counts, fisher=T)
answer14<-result$p.value<0.05 # FALSE
# There is a statistically significant association between MS and CCSVI. Answer is False
```

___

### Smoking Fingers

Researchers examined the presence of finger defects (fused fingers, extra fingers, or less than five fingers) in births of mothers who smoked (risk factor) during pregnancy, compared to control mothers who did not smoke during pregnancy. The data is found in the file Smoking fingers.csv. Calculate the Odds ratio and 95% confidence interval of the odds ratio. Use a Chi-Square test to determine if this difference is significant. Don’t forget that the risk factor must go in the row, and the outcome in the column.

```{r, echo=FALSE}
# question 15 A) The odds ratio for finger defects with maternal smoking compared to non-smoking is 1.31, with a 95% confidence interval of 1.19 to 1.44.
# question 15 B) The relative risk for finger defect with smoking is 1.19.
# question 16. The association between finger defects and maternal smoking is statistically significant. True

d<-read.csv("smoking fingers.csv")
counts<-table(d$maternalSmoking, d$fingerType)
pt<-prop.table(counts, margin=1)*100

OR<-oddsratio(counts, rev="column")$measure[-1,]
answer15a<-OR

RR<-riskratio(counts, rev="column")$measure[-1,][1]
answer15b<-RR

result<-chisq.test(counts)
answer16<-result$p.value<0.05


```

___

#### Answer questions 12-16 on sakai

<br>

___

#### Chi Squared Statistical Table:

![Chi Square Statistical Table](ChiSquareTable.jpeg)
